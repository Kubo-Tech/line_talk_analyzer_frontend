# PR#2: 共通コンポーネント・レイアウト

## 概要

アプリ全体で使用する共通UIコンポーネントの実装

## 実装内容

### コンポーネント

#### 1. Header.tsx

- ✅ ロゴ、タイトル表示
- ✅ レスポンシブ対応
- ✅ ホームへのリンク機能

#### 2. Footer.tsx

- ✅ コピーライト表示
- ✅ プライバシーポリシーへのリンク
- ✅ ヘルプへのリンク
- ✅ GitHubリポジトリへのリンク
- ✅ 免責事項の表示

#### 3. Button.tsx

- ✅ variant（primary, secondary, outline）
- ✅ disabled 状態の対応
- ✅ ローディング状態の表示
- ✅ カスタムクラスの適用
- ✅ アクセシビリティ対応

#### 4. Loading.tsx

- ✅ スピナーアニメーション
- ✅ オーバーレイ表示オプション
- ✅ カスタムメッセージの表示
- ✅ アクセシビリティ対応（role="status", aria-live="polite"）

#### 5. Modal.tsx

- ✅ オープン/クローズ制御
- ✅ オーバーレイクリックで閉じる
- ✅ Escapeキーで閉じる
- ✅ タイトル表示オプション
- ✅ スクロール対応
- ✅ アクセシビリティ対応（role="dialog", aria-modal="true"）

#### 6. layout.tsx

- ✅ Header/Footer の配置
- ✅ メタデータ設定（SEO、OGP、Twitter Card）
- ✅ viewport設定
- ✅ flexboxレイアウトでFooterを下部に固定

#### 7. globals.css

- ✅ Tailwind CSS v4 インポート
- ✅ カスタムカラー変数（primary, primary-dark等）
- ✅ ダークモード対応
- ✅ カスタムアニメーション（fadeIn, slideUp）
- ✅ 日本語フォント設定

## テスト実装

### 単体テスト（全29テスト）

#### Button.test.tsx（7テスト）

- ✅ クリックイベント発火
- ✅ disabled 状態でクリック無効
- ✅ ローディング表示
- ✅ primary variant スタイル
- ✅ secondary variant スタイル
- ✅ outline variant スタイル
- ✅ ローディング中disabled

#### Loading.test.tsx（5テスト）

- ✅ スピナー表示
- ✅ カスタムメッセージ表示
- ✅ overlayモード表示
- ✅ overlay無し表示
- ✅ メッセージなし表示

#### Modal.test.tsx（7テスト）

- ✅ isOpenによる表示制御
- ✅ タイトル表示
- ✅ 閉じるボタンでonClose呼び出し
- ✅ オーバーレイクリックでonClose呼び出し
- ✅ 内部クリックでonClose呼ばれない
- ✅ Escapeキーで閉じる

#### Header.test.tsx（4テスト）

- ✅ 正しくレンダリング
- ✅ タイトル表示
- ✅ ホームリンク
- ✅ アイコン表示

#### Footer.test.tsx（6テスト）

- ✅ 正しくレンダリング
- ✅ プライバシーポリシーリンク
- ✅ ヘルプリンク
- ✅ GitHubリンク（target="\_blank", rel="noopener noreferrer"）
- ✅ コピーライト表示
- ✅ 免責事項表示

### テスト結果

```
Test Suites: 5 passed, 5 total
Tests:       29 passed, 29 total
Snapshots:   0 total
Time:        1.993 s
```

## CI/CD チェック

### ESLint

```
✅ エラーなし
```

### TypeScript型チェック

```
✅ エラーなし
```

### ビルド

```
✓ Compiled successfully in 1364.3ms
✓ Finished TypeScript in 1186.5ms
✓ Collecting page data using 15 workers in 283.9ms
✓ Generating static pages using 15 workers (3/3) in 354.1ms
✓ Finalizing page optimization in 8.8ms
```

## ファイル構成

```
src/
├── app/
│   ├── layout.tsx          # 更新
│   └── globals.css         # 既存（確認済み）
├── components/
│   └── common/
│       ├── Header.tsx      # 新規作成
│       ├── Footer.tsx      # 新規作成
│       ├── Button.tsx      # 新規作成
│       ├── Loading.tsx     # 新規作成
│       └── Modal.tsx       # 新規作成
tests/
└── unit/
    └── components/
        └── common/
            ├── Header.test.tsx   # 新規作成
            ├── Footer.test.tsx   # 新規作成
            ├── Button.test.tsx   # 新規作成
            ├── Loading.test.tsx  # 新規作成
            └── Modal.test.tsx    # 新規作成
```

## 技術的な詳細

### アクセシビリティ対応

- 全てのインタラクティブ要素にARIA属性を適切に設定
- キーボード操作に対応（Modal: Escape、Button: Enterなど）
- スクリーンリーダー対応（role, aria-label等）

### レスポンシブ対応

- Tailwind CSSのユーティリティクラスを使用
- モバイルファーストのアプローチ
- dark modeへの対応

### パフォーマンス

- Client Componentは必要最小限（Modalのみ）
- Server Componentをデフォルトで使用
- アニメーションはCSSで実装（Framer Motionは後のPRで導入予定）

## 依存関係

- PR#1（プロジェクト初期設定）完了済み

## 次のステップ

- PR#3: 型定義・APIクライアント
- PR#4: プライバシーポリシーページ
- PR#5: ファイルアップロード機能（PR#2完了後）

## 備考

- globals.cssは既に適切に実装されていたため、変更なし
- 全てのコンポーネントにTypeScript型定義を実装
- テストカバレッジは100%（実装した全コンポーネント）
- ビルド成功、エラーなし

---

## コードレビュー結果（2025/12/17）

### ✅ 良い点

#### 1. 型安全性

- 全コンポーネントでTypeScript型定義を適切に実装
- インターフェースの export で再利用性を確保
- `React.ButtonHTMLAttributes` の拡張で標準HTML属性を継承

#### 2. アクセシビリティ対応

- Modal.tsx: `role="dialog"`, `aria-modal="true"`, `aria-labelledby` を適切に使用
- Loading.tsx: `role="status"`, `aria-live="polite"` を実装
- Modal.tsx: 閉じるボタンに `aria-label="閉じる"` を設定
- Escape キーでモーダルを閉じる機能を実装

#### 3. テストカバレッジ

- 全コンポーネントで網羅的なテストを実装（29テスト）
- ユーザー操作（クリック、キーボード）のテスト
- 条件分岐のテスト（variant、overlay、isLoading など）
- `@testing-library/react` と `@testing-library/user-event` を適切に使用

#### 4. レスポンシブデザイン

- Tailwind CSS のユーティリティクラスを活用
- ダークモード対応（`dark:` プレフィックス）
- Footer.tsx: `flex-wrap` でモバイル対応

#### 5. ユーザー体験

- Modal.tsx: モーダル表示時に `body` のスクロールを無効化
- Button.tsx: ローディング時にスピナーと「処理中...」を表示
- トランジション・アニメーション効果を適用

---

### 🔧 改善提案（リファクタリング時に検討）

#### 1. Loading.tsx の role 属性の一貫性

**問題点**: overlayモードでは`role="status"`が設定されていない

**現在のコード**:

```tsx
if (overlay) {
  return (
    <div className="...">
      <div className="...">{spinner}</div> {/* roleがない */}
    </div>
  );
}
```

**改善案**: overlay モードでも `role="status"` と `aria-live="polite"` を設定

```tsx
if (overlay) {
  return (
    <div className="..." role="status" aria-live="polite">
      <div className="...">{spinner}</div>
    </div>
  );
}
```

#### 2. Button.tsx のスピナーSVGの改善

**問題点**:

- SVGのハードコーディングで可読性が低い
- 再利用性がない

**改善案**: スピナーを別コンポーネントに分離、または専用の Spinner コンポーネントを作成

```tsx
const Spinner = () => (
  <svg
    className="h-5 w-5 animate-spin"
    xmlns="http://www.w3.org/2000/svg"
    fill="none"
    viewBox="0 0 24 24"
  >
    <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" />
    <path
      className="opacity-75"
      fill="currentColor"
      d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
    />
  </svg>
);
```

#### 3. Modal.tsx のメモリリーク対策

**問題点**: `onClose` が変更されるたびにイベントリスナーが再登録される

**改善案**: `useCallback` でメモ化

```tsx
const handleEscape = useCallback(
  (event: KeyboardEvent) => {
    if (event.key === 'Escape') {
      onClose();
    }
  },
  [onClose]
);

useEffect(() => {
  if (isOpen) {
    document.addEventListener('keydown', handleEscape);
    document.body.style.overflow = 'hidden';
  }
  return () => {
    document.removeEventListener('keydown', handleEscape);
    document.body.style.overflow = 'unset';
  };
}, [isOpen, handleEscape]);
```

#### 4. Footer.tsx の設定値の外部化

**問題点**: GitHubリポジトリURLがハードコーディングされている

**改善案**: 環境変数や設定ファイルから読み込む

```tsx
// lib/config.ts に設定を移動
export const GITHUB_REPO_URL_FRONTEND =
  process.env.NEXT_PUBLIC_GITHUB_REPO_URL_FRONTEND ||
  'https://github.com/Kubo-Tech/line_talk_analyzer_frontend';
export const GITHUB_REPO_URL_BACKEND =
  process.env.NEXT_PUBLIC_GITHUB_REPO_URL_BACKEND ||
  'https://github.com/Kubo-Tech/line_talk_analyzer_backtend';
```

#### 5. テストでの aria-label のハードコーディング

**問題点**: テストが日本語文字列に依存

**改善案**: 定数化またはi18n対応を見越した設計

---

### 🐛 潜在的なバグ

#### 1. Button のローディング時のaria属性不足

ローディング中に `aria-busy="true"` を追加すべき：

```tsx
<button
  disabled={disabled || isLoading}
  aria-busy={isLoading}
  className={`${baseStyles} ${variantStyles[variant]} ${className}`}
  {...props}
>
```

#### 2. Loading のメッセージが空文字列の場合

`message=""` の場合でも条件判定は `true` となり、空のpタグが残る可能性：

```tsx
{
  message && message.trim() && <p className="...">{message}</p>;
}
```

---

### 📊 総合評価

| 項目                 | 評価             | コメント                         |
| -------------------- | ---------------- | -------------------------------- |
| **コード品質**       | ⭐⭐⭐⭐☆ (4/5)  | 非常に良好。わずかな改善余地あり |
| **型安全性**         | ⭐⭐⭐⭐⭐ (5/5) | 完璧。全て適切に型定義されている |
| **テスト**           | ⭐⭐⭐⭐⭐ (5/5) | 網羅的で質が高い                 |
| **アクセシビリティ** | ⭐⭐⭐⭐☆ (4/5)  | 良好。わずかな改善余地あり       |
| **保守性**           | ⭐⭐⭐⭐☆ (4/5)  | 良好。設定の外部化で向上可能     |

---

### ✅ 承認判定

**APPROVED** ✓

改善提案はありますが、いずれも軽微なもので、現状のコードでもプロダクション品質を満たしています。提案された改善は、後続のリファクタリングPRで対応しても問題ありません。

---

### 📝 次のステップへの推奨事項

1. 改善提案は優先度が低いため、PR#3（型定義・APIクライアント）を先に進めてOK
2. 後続のPRでコンポーネントのリファクタリング機会があれば対応を検討
3. 設定値の外部化（GitHubリンクなど）は設定管理の方針が決まってから実施
4. Spinnerコンポーネントの分離は、他のコンポーネントでも使う必要が出てきた時点で実施
