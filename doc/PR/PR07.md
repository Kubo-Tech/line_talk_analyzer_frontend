# PR#07: プライバシー同意機能

## 概要

トップページにプライバシーポリシーへの同意機能を実装しました。ユーザーはモーダルでプライバシーポリシーを確認してから同意する必要があり、ファイル選択済み かつ プライバシー同意済みの場合のみ、解析ボタンが有効化されます。

## 実装内容

### 1. usePrivacyConsentフック (`src/hooks/usePrivacyConsent.ts`)

プライバシーポリシーの同意状態と既読状態を管理するカスタムフックです。

**主な機能:**

- 同意状態の管理（isConsented）
- ポリシー既読状態の管理（hasReadPolicy）
- 同意状態の切り替え関数（toggleConsent）
- 既読状態のマーク関数（markAsRead）

**実装の特徴:**

- 2つの独立したブール値による状態管理
- ポリシーを確認しないと同意できない仕組み
- セッション内でのみ状態を保持（ページリロードで初期化）

```typescript
export function usePrivacyConsent() {
  const [isConsented, setIsConsented] = useState(false);
  const [hasReadPolicy, setHasReadPolicy] = useState(false);

  const toggleConsent = () => {
    setIsConsented((prev) => !prev);
  };

  const markAsRead = () => {
    setHasReadPolicy(true);
  };

  return {
    isConsented,
    hasReadPolicy,
    toggleConsent,
    markAsRead,
  };
}
```

### 2. PrivacyConsentコンポーネント (`src/components/upload/PrivacyConsent.tsx`)

プライバシーポリシーへの同意を取得するUIコンポーネントです。

**主な機能:**

- チェックボックスによる同意取得（ポリシー確認後のみ有効化）
- プライバシーポリシーモーダルを開くボタン
- 既読状態に応じたチェックボックスの有効/無効制御

**Props:**

- `isConsented: boolean` - 同意済みかどうか
- `hasReadPolicy: boolean` - ポリシーを既読したかどうか
- `onConsentChange: () => void` - 同意状態変更時のコールバック
- `onOpenPolicy: () => void` - ポリシーモーダルを開く時のコールバック

**UI構成:**

```
┌─────────────────────────────────┐
│ ☐ [プライバシーポリシー]に同意する │
│   (未読の場合はチェックボックス無効) │
└─────────────────────────────────┘
```

**デザインの特徴:**

- 白背景のカードデザイン（`bg-white shadow-sm`）
- チェックボックスは大きめのサイズ（`h-5 w-5`）で操作しやすい
- プライバシーポリシーボタンは青色（`text-blue-600`）でインライン表示
- 未読時はチェックボックスが無効化され、半透明表示（`opacity-50`）
- アクセシビリティ対応（aria-label）

### 3. PrivacyPolicyModalコンポーネント (`src/components/common/PrivacyPolicyModal.tsx`)

プライバシーポリシーの全文を表示するモーダルコンポーネントです。

\*\*主な4. トップページへの統合 (`src/app/page.tsx`)

既存のトップページにプライバシー同意機能を統合しました。

**変更内容:**

1. **usePrivacyConsentフックの使用**

   ```typescript
   const { isConsented, hasReadPolicy, toggleConsent, markAsRead } = usePrivacyConsent();
   const [isModalOpen, setIsModalOpen] = useState(false);
   ```

2. **PrivacyPolicyModalの統合**
   - モーダルの開閉状態を管理
   - 閉じる時にmarkAsRead()を呼び出してポリシーを既読にする

3. **PrivacyConsentコンポーネントの配置**
   - ヘルプリンクと解析ボタンの間に配置
   - hasReadPolicyとonOpenPolicyを渡す

4. **解析ボタンの有効/無効制御**

   ```typescript
   const isAnalyzeButtonEnabled = uploadedFile !== null && isConsented;
   ```

   - ファイル選択済み AND 同意済み → ボタン有効
   - それ以外 → ボタン無効

5. **ユーザーフィードバック**
   - ボタン無効時に状況に応じたメッセージを表示
   - 「ファイルを選択し、プライバシーポリシーに同意してください」
   - 「ファイルを選択してください」
   - 「プライバシーポリシーに同意してください」

6. **ボタンのスタイル動的変更**
   - 有効時: `bg-blue-600 hover:bg-blue-700`
   - 無効時: `bg-gray-400 cursor-not-allowed`

### 5. プライバシーページの削除とフッター更新

**削除されたファイル:**

- `src/app/privacy/page.tsx` - モーダルで表示するため専用ページは不要に

**更新されたファイル:**

- `src/components/common/Footer.tsx` - プライバシーポリシーへのリンクを削除

**デザインの特徴:**

- 画面中央に表示、最大幅2xl
- 高さは画面の80%まで
- スクロール可能なコンテンツエリア
- 閉じるボタンは×アイコン（ヘッダー）と青いボタン（フッター）
- 黒い半透明オーバーレイ

### 3. トップページへの統合 (`src/app/page.tsx`)

既存のトップページにプライバシー同意機能を統合しました。

**変更内容:**

1. **usePrivacyConsentフックの使用**

   ```typescript
   const { isConsented, toggleConsent } = usePrivacyConsent();
   ```

2. **PrivacyConsentコンポーネントの配置**
   - ヘルプリンクと解析ボタンの間に配置
   - 適切なセクション分けで視覚的に整理

3. **解析ボタンの有効/無効制御**

   ```typescript
   const isAnalyzeButtonEnabled = uploadedFile !== null && isConsented;
   ```

   - ファイル選択済み AND 同意済み → ボタン有効
   - それ以外 → ボタン無効
     全135テスト）

#### PrivacyConsent コンポーネント（10テスト）

**レンダリング（2テスト）:**

- ✅ チェックボックスが表示される
- ✅ プライバシーポリシーへのボタンが表示される

**チェックボックスの動作（4テスト）:**

- ✅ isConsented=falseの場合、チェックされていない
- ✅ isConsented=trueの場合、チェックされている
- ✅ ポリシー既読の場合、チェックボックスをクリックするとonConsentChangeが呼ばれる
- ✅ ポリシー未読の場合、チェックボックスが無効である
- ✅ ポリシー既読の場合、チェックボックスが有効である

**プライバシーポリシーボタン（1テスト）:**

- ✅ ボタンをクリックするとonOpenPolicyが呼ばれる

**スタイリング（2テスト）:**

- ✅ ポリシー未読の場合、チェックボックスに無効スタイルが適用される
- ✅ ポリシー既読の場合、チェックボックスに有効スタイルが適用される

#### PrivacyPolicyModal コンポーネント（6テスト）

**表示制御（2テスト）:**

- ✅ isOpen=falseの場合、モーダルが表示されない
- ✅ isOpen=trueの場合、モーダルが表示される

**コンテンツ（3テスト）:**

- ✅ タイトルが表示される
- ✅ 必須同意項目が表示される
- ✅ データの取り扱いが表示される

**閉じる機能（1テスト）:**

- ✅ 閉じるボタンをクリックするとonCloseが呼ばれる

#### usePrivacyConsent フック（9テスト）

**初期状態（4テスト）:**

- ✅ isConsentedの初期値がfalse
- ✅ hasReadPolicyの初期値がfalse
- ✅ toggleConsent関数が提供される
- ✅ markAsRead関数が提供される

**toggleConsent（3テスト）:**

- ✅ 1回呼ぶとisConsentedがtrueになる
- ✅ 2回呼ぶとisConsentedが元に戻る
- ✅ 複数回呼んでも正しく切り替わる

**markAsRead（2テスト）:**

- ✅ markAsReadを呼ぶとhasReadPolicyがtrueになる
- ✅ markAsReadを複数回呼んでもhasReadPolicyはtrueのまま

#### トップページ統合テスト（17テスト）

**基本レンダリング（3テスト）:**

- ✅ ページタイトルが表示される
- ✅ 説明文が表示される
- ✅ ヘルプリンクが表示される

**プライバシー同意機能（6テスト）:**

- ✅ チェックボックスが表示される
- ✅ プライバシーポリシーへのボタンが表示される
- ✅ 初期状態ではチェックされていない
- ✅ 初期状態ではチェックボックスが無効である
- ✅ プライバシーポリシーボタンをクリックするとモーダルが開く
- ✅ モーダルを閉じるとチェックボックスが有効になる
- ✅ ポリシー確認後、チェックボックスをクリックするとチェック状態が切り替わる

**解析ボタンの有効/無効制御（7テスト）:**

- ✅ 初期状態ではボタンが無効
- ✅ ファイル未選択かつ同意なし → 適切なメッセージ表示
- ✅ 同意のみ → ボタン無効、ファイル選択を促すメッセージ
- ✅ ファイル選択のみ → ボタン無効、同意を促すメッセージ
- ✅ 両方あり → ボタン有効
- ✅ ボタン有効時のスタイル適用
- ✅ ボタン無効時のスタイル適用

**ファイル名表示（1テスト）:**

- ✅ ファイルアップロード後、ファイル名が表示される

#### Footer コンポーネント（更新、5テスト）

- ✅ Footerが表示される
- ✅ ヘルプページへのリンクが表示される
- ✅ GitHubフロントエンドリポジトリへのリンクが表示される
- ✅ GitHubバックエンドリポジトリへのリンクが表示される
- ✅ コピーライトが表示される

### テスト実行結果

### 新規作成

```
src/
├── hooks/
│   └── usePrivacyConsent.ts                     # 同意・既読状態管理フック
├── components/
│   ├── common/
│   │   └── PrivacyPolicyModal.tsx               # プライバシーポリシーモーダル
│   └── upload/
│       └── PrivacyConsent.tsx                   # 同意UIコンポーネント

tests/
├── unit/
│   ├── hooks/
│   │   └── usePrivacyConsent.test.ts            # フックのテスト
│   └── components/
│       ├── common/
│       │   └── PrivacyPolicyModal.test.tsx      # モーダルのテスト
│       └── upload/
│           └── PrivacyConsent.test.tsx          # 同意コンポーネントのテスト
└── integration/
    └── Home.test.tsx                            # 統合テスト
```

### 更新

```
src/
├── app/
│   └── page.tsx                                 # モーダル統合
└── components/
    └── common/
        └── Footer.tsx                           # プライバシーリンク削除

tests/
└── unit/
    └── components/
        └── common/
            └── Footer.test.tsx                  # プライバシーリンクテスト削除
```

### 削除

````
src/
└── app/
    └── privacy/
        └── page.tsx                             # 専用ページ削除（モーダル化）

tests/
└── unit/
    └── app/
        └── privacy/
            └── page.test.tsx                    # 削除されたページのテスト

全テストが成功しました（PR#1-6: 103テスト + PR#7: 28テスト = 131テスト）。

## 品質チェック

### ESLint

```bash
npm run lint
````

✅ エラーなし（警告なし）

### TypeScript

```bash
npx tsc --noEmit
```

✅ 型エラーなし

### ビルド

```bash
npm run build
```

✅ ビルド成功

- ルート `/` の静的生成成功
- 他のルート（`/help`, `/privacy`, `/_not-found`）も正常

## ファイルモーダル方式の採用

- 専用ページではなくモーダルでプライバシーポリシーを表示
- ユーザーの操作フローを中断させない
- モーダルを閉じると自動的に「既読」状態になる

**理由:**

- ページ遷移が不要でUX向上
- コンテキストの維持（トップページから離れない）
- モバイルでも使いやすい

### 4. 明確なフィードバック

- ボタンの有効/無効状態を視覚的に明示
- チェックボックスの無効状態を半透明で表現
- 状況に応じたメッセージで次のアクションを示唆
- ユーザーが迷わない設計

### 5. アクセシビリティ

- `aria-label`でチェックボックスの目的を明示
- キーボード操作対応
- モーダルのフォーカス管理
- 適切なコントラスト比
- フォーカス時のアウトライン

### 6. コンテンツの統一と整理

- プライバシーページとモーダルのコンテンツを統一
- 絵文字を削除して読みやすく
- 「必須同意項目」の見出しを他と統一（黒色）
- テーブル形式で情報を整理

### 7. 同意事項の透明性

- サービスの性質を明示（LINE社とは無関係）
- データの取り扱いを具体的に説明
- ユーザーが理解した上で同意できる
- GitHubリポジトリへのリンクで透明性を確保

```
src/
├── hooks/
│   └── usePrivacyConsent.ts      # 同意状態管理フック（新規）
├── components/
│   └── upload/
│       └── PrivacyConsent.tsx     # 同意UIコンポーネント（新規）
└── app/
    └── page.tsx                   # トップページ（更新）

tests/
├── unit/
│   ├── hooks/（既読状態追加）
- ✅ PrivacyConsentコンポーネントの実装（ゲート機能付き）
- ✅ PrivacyPolicyModalコンポーネントの実装
- ✅ トップページへの統合
- ✅ 解析ボタンの有効/無効制御
- ✅ ユーザーフィードバックメッセージ
- ✅ モーダルでのプライバシーポリシー表示
- ✅ プライバシーページの削除
- ✅ Footerの更新（プライバシーリンク削除）
- ✅ コンテンツの統一（絵文字削除、見出し統一）
- ✅ レスポンシブデザイン
- ✅ アクセシビリティ対応
- ✅ 単体テスト（25テスト）
- ✅ 統合テスト（17テスト）
- ✅ テスト修正（削除されたページのテスト削除
## 依存関係

### 前提PR

- ✅ PR#1: プロジェクト初期化
- ✅ PR#4: プライバシーポリシーページ（リンク先）
- ✅ PR#5: ファイルアップロード機能（統合先）

### 次のPR

- PR#8: API連携・解析処理（解析ボタンのクリック処理を実装）

## UI/UX設計

### ユーザーフロー

```

1. ページ訪問
   ↓
2. ファイル選択 または 同意チェック（順不同）
   ↓
3. 両方完了
   ↓
4. 解析ボタンが有効化
   ↓
5. 解析開始（PR#8で実装予定）

````

### ビジュアルデザイン

#### 同意セクション

- **カードデザイン**: 白背景、軽いシャドウで浮き上がる
- **チェックボックス**: 大きめサイズで操作しやすい
- **情報ボックス**: 青い背景で同意事項を明確に提示
- **リンク**: 青色でクリッカブルであることを明示

#### ボタンの状態

| 状態 | 背景色                 | カーソル      | ホバー効果                   |
| ---- | ---------------------- | ------------- | ---------------------------- |
| 有効 | 青 (`bg-blue-600`)     | `pointer`     | 濃い青 (`hover:bg-blue-700`) |
| 無効 | グレー (`bg-gray-400`) | `not-allowed` | なし                         |

### レスポンシブ対応

- モバイルファースト設計
- チェックボックスとラベルの適切な配置
- タップエリアの十分な確保
- 情報ボックスの可読性維持

## 実装のポイント

### 1. シンプルな状態管理

- LocalStorageやCookieは使用しない
- セッション内でのみ状態を保持
- ページリロードで同意をリセット（セキュリティ向上）

**理由:**

- プライバシーを尊重（同意を永続化しない）
- 実装がシンプル
- 毎回明示的な同意を取得
モーダルベースのアプローチ

**設計判断:**

- 専用ページではなくモーダルを採用
- ページ遷移のオーバーヘッドを削減
- ユーザーが現在のコンテキストを失わない

**実装のポイント:**

- モーダルの開閉状態を親コンポーネントで管理
- 閉じる時に`markAsRead()`を呼び出し
- オーバーレイクリックでも閉じられる

### コンポーネント設計

**Props vs State:**

- `PrivacyConsent`は制御されたコンポーネント（Controlled Component）
- 親コンポーネント（Home）が状態を管理
- 単方向データフロー

**メリット:**

- テストが容易
- 状態の追跡が簡単
- 再利用性が高い

### フックの設計

```typescript
// 2つの独立した状態を管理
export function usePrivacyConsent() {
  const [isConsented, setIsConsented] = useState(false);
  const [hasReadPolicy, setHasReadPolicy] = useState(false);

  const toggleConsent = () => {
    setIsConsented((prev) => !prev);
  };

  const markAsRead = () => {
    setHasReadPolicy(true);
  };

  return { isConsented, hasReadPolicy, toggleConsent, markAsRead };
}
````

**設計判断:**

- `setIsConsented`と`setHasReadPolicy`を直接公開しない
- 専用の関数（`toggleConsent`, `markAsRead`）のみ公開
- 状態の変更方法を制限し、予期しない変更を防止
- 必要に応じて拡張可能

### ゲート機能の実装

**チェックボックスの無効化:**

```typescript
<input
  type="checkbox"
  disabled={!hasReadPolicy}
  className={`... ${!hasReadPolicy ? 'cursor-not-allowed opacity-50' : ''}`}
/>
```

**視覚的フィードバック:**

- 未読時: 半透明（opacity-50）
- 既読時: 通常の表示
- ユーザーに状態が明確

### テスト戦略

#### 単体テスト

- コンポーネントとフックを独立してテスト
- モックを使用して依存関係を排除
- 境界値テスト（チェック/アンチェック、既読/未読）
- スタイリングのテスト（無効状態の半透明）

#### 統合テスト

- 実際のユーザー操作をシミュレート
- 複数コンポーネントの連携を確認
- エッジケース（ファイル選択/同意の順序）
- モーダルの開閉とチェックボックスの連動

## 実装の変遷

### 初期実装

- シンプルなチェックボックスのみ
- プライバシーページへのリンク

### 最終実装（改善後）

1. **モーダルの導入**: ページ遷移なしでポリシー確認
2. **ゲート機能**: ポリシー確認前は同意不可
3. **専用ページの削除**: モーダルに一本化
4. **コンテンツ整理**: 絵文字削除、見出し統一
5. **不要メッセージ削除**: UIの簡潔化

この実装により、ユーザーはプライバシーポリシーを必ず確認

- ✅ 統合テスト（14テスト）
- ✅ ESLint チェック
- ✅ TypeScript 型チェック
- ✅ ビルドテスト
- ✅ 既存機能の動作確認
- ✅ ドキュメント作成

## 次のステップ

PR#7が完了しました。次は **PR#8（API連携・解析処理）** に進みます。

PR#8では以下を実装します：

1. **useAnalyzeフック**
   - 解析APIへのリクエスト送信
   - ローディング状態管理
   - エラーハンドリング

2. **トップページの完成**
   - 解析ボタンのクリック処理
   - ローディング表示
   - 結果ページへの遷移

3. **統合テスト**
   - 完全なユーザーフロー
   - エラーケース

---

## 技術的詳細

### コンポーネント設計

**Props vs State:**

- `PrivacyConsent`は制御されたコンポーネント（Controlled Component）
- 親コンポーネント（Home）が状態を管理
- 単方向データフロー

**メリット:**

- テストが容易
- 状態の追跡が簡単
- 再利用性が高い

### フックの設計

```typescript
// シンプルな実装で十分な機能を提供
export function usePrivacyConsent() {
  const [isConsented, setIsConsented] = useState(false);

  const toggleConsent = () => {
    setIsConsented((prev) => !prev);
  };

  return { isConsented, toggleConsent };
}
```

**設計判断:**

- `setIsConsented`を直接公開せず、`toggleConsent`のみ公開
- 状態の変更方法を制限し、予期しない変更を防止
- 必要に応じて拡張可能（例: `resetConsent`関数の追加）

### テスト戦略

#### 単体テスト

- コンポーネントとフックを独立してテスト
- モックを使用して依存関係を排除
- 境界値テスト（チェック/アンチェック）

#### 統合テスト

- 実際のユーザー操作をシミュレート
- 複数コンポーネントの連携を確認
- エッジケース（ファイル選択/同意の順序）

この実装により、ユーザーはプライバシーポリシーを理解した上で、明示的に同意してサービスを利用できるようになりました。
